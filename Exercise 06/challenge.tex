% Template for solutions write-ups, STAT 460/560
% Some basic notation is defined in 'macros/basic-math-macros'

\documentclass{article}
\input{macros/solutions-template}  % DO NOT CHANGE
\input{macros/typesetting-macros}  % DO NOT CHANGE
\input{macros/basic-math-macros} 
\graphicspath{{./figures/}}



\begin{document}



% FILL IN:
%  - YOUR NAME, YOUR EMAIL (self-explanatory)
%  - The assignment number goes in ##
\problemset{Junsong Tang}{junsong.tang@stat.ubc.ca}{Challenge 6}

\qsol{Model}
Below is the Stan code for model and code for fitting:
\begin{lstlisting}[language=C]
// Stan code
data { 
  int N; 
  array[N] int failures;
  array[N] int launches;
}
parameters { 
  real<lower=0> mu;
  real<lower=0> s;
  vector<lower=0, upper=1>[N] probs; 
}
model {
  mu ~ uniform(0,1);
  s ~ exponential(1.0/10000);
  probs ~ beta_proportion(mu, s);
  failures ~ binomial(launches, probs);
}

\end{lstlisting}

\begin{lstlisting}[language=R]
set.seed(2025)
suppressPackageStartupMessages(require(rstan))
suppressPackageStartupMessages(require(ggplot2))
suppressPackageStartupMessages(require(dplyr))

df = read.csv(url("https://raw.githubusercontent.com/UBC-Stat-ML/web447/main/data/launches.csv")) %>%
    select(LV.Type, Suc)  %>%
    group_by(LV.Type) %>%
    summarise(
    numberOfLaunches = n(),
    numberOfFailures = sum(Suc == "F")
    )
ggplot(df, aes(x = numberOfFailures / numberOfLaunches)) +
    geom_histogram() + 
    xlab("pi_hat = numberOfFailures_i / numberOfLaunches_i") +
    geom_rug(alpha = 0.1) + 
    theme_minimal()



fit = sampling(stan_model(file.choose()), 
                data=list(N=nrow(df), failures=df$numberOfFailures, launches=df$numberOfLaunches),
                iter=5000, control = list(max_treedepth = 15))
samples = extract(fit)$probs
xs = df$LV.Type
n_samples = nrow(samples)
ys = df$numberOfFailures / df$numberOfLaunches


# check some specific type of rocket and their failure probabilities
# choose first 20 rockets
subset = c(1:20)
plot(subset, ys[subset],
        xlab = paste0("Types of rocket: ", xs[subset]), 
        ylab = "probability of failure")

for (i in 1:n_samples) {
    lines(subset, samples[i,subset], col = rgb(red = 0, green = 0, blue = 0, alpha = 0.01))
}
\end{lstlisting}


\qsol{Disadvantage of the model and improvement}


% Optional: Feedback on assignment
% \qsol{Feedback on assignment}

 
\end{document}
